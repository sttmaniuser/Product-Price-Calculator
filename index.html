<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Cost Calculator with Backup</title>
  <style>
    /* Reset and base */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #f9fafc;
      color: #333;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      margin-bottom: 1rem;
      color: #2c3e50;
      text-align: center;
    }

    .container {
      background: white;
      max-width: 600px;
      width: 100%;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      border: 1.5px solid #d1d9e6;
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #3498db;
    }

    .flex-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    .flex-row > * {
      flex: 1;
    }
    .btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    .btn-secondary {
      background-color: #7f8c8d;
    }
    .btn-secondary:hover {
      background-color: #616a6b;
    }

    fieldset {
      border: 1.5px solid #d1d9e6;
      border-radius: 8px;
      padding: 15px 20px 20px;
      margin-bottom: 1rem;
      background: #fafbfd;
    }
    legend {
      font-weight: 700;
      color: #2c3e50;
      padding: 0 10px;
      font-size: 1.1rem;
    }

    #totalCostDisplay {
      font-weight: 700;
      font-size: 1.2rem;
      margin-top: 10px;
      color: #2c3e50;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }
    th {
      background-color: #3498db;
      color: white;
      font-weight: 700;
    }
    tr:hover {
      background-color: #ecf4fb;
    }

    #search {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1.5px solid #d1d9e6;
      font-size: 1rem;
      margin-top: 10px;
      margin-bottom: 15px;
    }

    .action-btn {
      background-color: #e74c3c;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      margin: 0 2px;
      transition: background-color 0.3s ease;
    }
    .action-btn.edit {
      background-color: #27ae60;
    }
    .action-btn:hover {
      filter: brightness(85%);
    }
    /* Category chip list */
    .chip-list{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:1rem;
    }
    .chip{
      background:#ecf4fb;
      padding:6px 10px;
      border-radius:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.85rem;
    }
    .chip .del-chip{
      background:none;
      border:none;
      color:#e74c3c;
      font-size:1rem;
      cursor:pointer;
      line-height:1;
    }
  </style>
</head>
<body>
  <h2>Product Cost Calculator with Backup</h2>
  <div class="container">
    <div class="form-group">
      <label for="productName">Product Name:</label>
      <input type="text" id="productName" placeholder="Enter product name" />
    </div>

    <div class="form-group">
      <label for="category">Category:</label>
      <div class="flex-row">
        <select id="category"></select>
        <input type="text" id="newCategory" placeholder="Add new category" />
        <button class="btn" onclick="addCategory()">Add</button>
      </div>
      <!-- Chip list to display categories with delete option -->
      <div id="chipContainer" class="chip-list"></div>
    </div>

    <fieldset>
      <legend>Total Cost Breakdown</legend>
      <div class="form-group">
        <label for="makingCharges">Making Charges:</label>
        <input type="number" id="makingCharges" min="0" oninput="calculateTotal()" />
      </div>
      <div class="form-group">
        <label for="materialsCost">Materials Cost:</label>
        <input type="number" id="materialsCost" min="0" oninput="calculateTotal()" />
      </div>
      <div class="form-group">
        <label for="transportCost">Transport Cost:</label>
        <input type="number" id="transportCost" min="0" oninput="calculateTotal()" />
      </div>
      <div class="form-group">
        <label for="miscCost">Miscellaneous Cost:</label>
        <input type="number" id="miscCost" min="0" oninput="calculateTotal()" />
      </div>
      <div class="form-group">
        <label for="sellingPercentage">Selling Price Percentage (%):</label>
        <input type="number" id="sellingPercentage" min="0" value="210" />
      </div>
      <div id="totalCostDisplay">Total Cost: ₹<span id="totalCost">0.00</span></div>
    </fieldset>

    <div style="text-align:center;">
      <button class="btn" onclick="addProduct()">Add Product</button>
      <button class="btn btn-secondary" onclick="backupData()">Backup Data</button>
      <button class="btn btn-secondary" onclick="document.getElementById('restoreInput').click()">Restore Data</button>
      <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="restoreData(event)" />
    </div>

    <input
      type="text"
      id="search"
      placeholder="Search by product name or category..."
      oninput="renderTable()"
    />

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Total Cost (₹)</th>
          <th>Selling Price (₹)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>
  </div>

  <script>
    // Load data from localStorage or initialize
    let products = JSON.parse(localStorage.getItem('products')) || [];
    let categories = JSON.parse(localStorage.getItem('categories')) || ["Sensors", "Modules", "Lab Kits", "Boards"];
    let editIndex = -1;

    // Populate category dropdown and chip list
    function populateCategories() {
      const categorySelect = document.getElementById('category');
      const chipContainer = document.getElementById('chipContainer');
      categorySelect.innerHTML = '';
      chipContainer.innerHTML = '';
      categories.forEach((cat, idx) => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);

        // chip
        const chip=document.createElement('div');
        chip.className='chip';
        chip.innerHTML=`${cat} <button class="del-chip" title="Delete category" onclick="deleteCategory(${idx})">&times;</button>`;
        chipContainer.appendChild(chip);
      });
    }

    // Add new category
    function addCategory() {
      const newCatInput = document.getElementById('newCategory');
      const newCat = newCatInput.value.trim();
      if (newCat === '') {
        alert("Please enter a category name.");
        return;
      }
      if (categories.includes(newCat)) {
        alert("Category already exists.");
        return;
      }
      categories.push(newCat);
      localStorage.setItem('categories', JSON.stringify(categories));
      newCatInput.value = '';
      populateCategories();
      alert(`Category "${newCat}" added!`);
    }

    // Delete category
    function deleteCategory(index){
      const cat=categories[index];
      // Check if any product uses this category
      const used=products.some(p=>p.category===cat);
      if(used){
        alert(`Cannot delete category \"${cat}\" because it is assigned to one or more products.`);
        return;
      }
      if(confirm(`Delete category \"${cat}\"?`)){
        categories.splice(index,1);
        localStorage.setItem('categories', JSON.stringify(categories));
        populateCategories();
      }
    }

    // Calculate total cost
    function calculateTotal() {
      const making = parseFloat(document.getElementById('makingCharges').value) || 0;
      const materials = parseFloat(document.getElementById('materialsCost').value) || 0;
      const transport = parseFloat(document.getElementById('transportCost').value) || 0;
      const misc = parseFloat(document.getElementById('miscCost').value) || 0;
      const total = making + materials + transport + misc;
      document.getElementById('totalCost').textContent = total.toFixed(2);
      return total;
    }

    // Add or update product
    function addProduct() {
      const name = document.getElementById('productName').value.trim();
      const category = document.getElementById('category').value;
      const making = parseFloat(document.getElementById('makingCharges').value) || 0;
      const materials = parseFloat(document.getElementById('materialsCost').value) || 0;
      const transport = parseFloat(document.getElementById('transportCost').value) || 0;
      const misc = parseFloat(document.getElementById('miscCost').value) || 0;
      const percent = parseFloat(document.getElementById('sellingPercentage').value) || 210;
      const total = making + materials + transport + misc;
      const selling = +(total * (percent / 100)).toFixed(2);

      if (!name) {
        alert("Please enter product name.");
        return;
      }
      if (total === 0) {
        alert("Total cost cannot be zero.");
        return;
      }

      const product = { name, category, making, materials, transport, misc, total, selling, percent };

      if (editIndex === -1) {
        products.push(product);
      } else {
        products[editIndex] = product;
        editIndex = -1;
      }

      localStorage.setItem('products', JSON.stringify(products));
      clearForm();
      renderTable();
      alert('Product saved successfully!');
    }

    // Clear form fields
    function clearForm() {
      document.getElementById('productName').value = '';
      document.getElementById('makingCharges').value = '';
      document.getElementById('materialsCost').value = '';
      document.getElementById('transportCost').value = '';
      document.getElementById('miscCost').value = '';
      document.getElementById('sellingPercentage').value = 210;
      document.getElementById('totalCost').textContent = '0.00';
      editIndex = -1;
    }

    // Render products in table
    function renderTable() {
      const search = document.getElementById('search').value.toLowerCase();
      const table = document.getElementById('productTable');
      table.innerHTML = '';
      products
        .filter(p => p.name.toLowerCase().includes(search) || p.category.toLowerCase().includes(search))
        .forEach((p, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>₹${p.total.toFixed(2)}</td>
            <td>₹${p.selling.toFixed(2)} (${p.percent}%)</td>
            <td>
              <button class="action-btn edit" onclick="fillEditForm(${index})">Edit</button>
              <button class="action-btn" onclick="deleteProduct(${index})">Delete</button>
            </td>
          `;
          table.appendChild(row);
        });
    }

    // Fill form for editing
    function fillEditForm(index) {
      const p = products[index];
      document.getElementById('productName').value = p.name;
      document.getElementById('category').value = p.category;
      document.getElementById('makingCharges').value = p.making;
      document.getElementById('materialsCost').value = p.materials;
      document.getElementById('transportCost').value = p.transport;
      document.getElementById('miscCost').value = p.misc;
      document.getElementById('sellingPercentage').value = p.percent;
      document.getElementById('totalCost').textContent = p.total.toFixed(2);
      editIndex = index;
    }

    // Delete product
    function deleteProduct(index) {
      if (confirm("Are you sure you want to delete this product?")) {
        products.splice(index, 1);
        localStorage.setItem('products', JSON.stringify(products));
        renderTable();
      }
    }

    // Backup data to JSON file
    function backupData() {
      const backup = { products, categories };
      const dataStr = JSON.stringify(backup, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `product_backup_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      alert('Backup downloaded! Save this file safely.');
    }

    // Restore data from JSON file
    function restoreData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const json = JSON.parse(e.target.result);
          if (json.products && json.categories) {
            products = json.products;
            categories = json.categories;
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('categories', JSON.stringify(categories));
            populateCategories();
            renderTable();
            alert("Data restored successfully!");
          } else {
            alert("Invalid backup file!");
          }
        } catch {
          alert("Failed to read backup file!");
        }
      };
      reader.readAsText(file);
      // Reset file input so same file can be uploaded again if needed
      event.target.value = '';
    }

    // Initial population
    populateCategories();
    renderTable();
  </script>
</body>
</html>
